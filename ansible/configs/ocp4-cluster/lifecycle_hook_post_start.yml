---
# Post Start actions for OCP 4 Cluster configs

- name: Build inventory
  hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
  - when: cloud_provider == 'ec2'
    block:
    - name: Run infra-ec2-create-inventory Role
      include_role:
        name: infra-ec2-create-inventory

    - name: Run Common SSH Config Generator Role
      include_role:
        name: infra-common-ssh-config-generate
      when: "'bastions' in groups"

- name: Set ansible_ssh_extra_args
  hosts:
  - all:!windows:!network
  gather_facts: false
  any_errors_fatal: true
  ignore_errors: false
  tasks:
  - name: Set facts for remote access
    set_fact:
      ansible_ssh_extra_args: >-
        {{ ansible_ssh_extra_args|d() }}
        -F {{hostvars.localhost.output_dir}}/{{ env_type }}_{{ guid }}_ssh_conf

- name: Run recover cluster actions
  hosts: bastions
  run_once: true
  become: false
  gather_facts: false
  tasks:
  - name: Set Ansible Python interpreter to k8s virtualenv
    set_fact:
      ansible_python_interpreter: /opt/virtualenvs/k8s/bin/python

  - name: Recover cluster if it missed cert rotation
    when: ACTION == 'start'
    block:
    - name: Wait (default 3m) for Nodes to settle and pods to start
      pause:
        seconds: "{{ lifecycle_start_pause | default(180) }}"

    - name: Get CSRs that need to be approved
      k8s_facts:
        api_version: certificates.k8s.io/v1beta1
        kind: CertificateSigningRequest
        # Field selectors don't seem to work
        # field_selectors:
        # - status.conditions[0].type="Pending"
      register: r_csrs

    - name: Approve all Pending CSRs
      when: r_csrs.resources | length > 0
      command: "oc adm certificate approve {{ item.metadata.name }}"
      loop: "{{ r_csrs.resources }}"

    - name: Wait 10s for additional CSRs to appear
      pause:
        seconds: 10

    - name: Get additional CSRs that need to be approved
      k8s_facts:
        api_version: certificates.k8s.io/v1beta1
        kind: CertificateSigningRequest
        # Field selectors don't seem to work
        # field_selectors:
        # - status.conditions[0].type = "Pending"
      register: r_new_csrs

    - name: Approve all additional Pending CSRs
      when: r_new_csrs.resources | length > 0
      command: "oc adm certificate approve {{ item.metadata.name }}"
      loop: "{{ r_new_csrs.resources }}"

    # Get OpenShift Version to determine if we need additional recovery actions
    - name: Get OpenShift ClusterVersion
      k8s_facts:
        api_version: config.openshift.io/v1
        kind: ClusterVersion
        name: version
      register: r_cluster_version
    - name: Set ocp4_cluster_version fact
      set_fact:
        ocp4_cluster_version: "{{ r_cluster_version.resources[0].status.history[0].version }}"

    # Only do the following recovery actions on 4.4.7 and higher 4.4 OpenShift versions
    # Before 4.4.7 the cluster would still be broken. Starting in 4.5 this won't be necessary
    # Also only do when previously there were certificates to be approved
    - name: Workaround for OCP 4.4 bug (API Servers need restarting)
      when:
      - ocp4_cluster_version is version_compare('4.4.7', '>=')
      - ocp4_cluster_version is version_compare('4.5.0', '<')
      - r_csrs.resources | length > 0 or r_new_csrs.resources | length > 0
      block:
      - name: Wait 5 minutes for things to settle
        pause:
          seconds: 300

      - name: Find openshift-apiserver pods
        k8s_facts: 
          api_version: v1
          kind: Pod
          namespace: openshift-apiserver
        register: r_apiserver_pods

      - name: Restart openshift-apiserver pods
        k8s:
          state: absent
          api_version: v1
          kind: Pod
          namespace: openshift_apiserver
          name: "{{ item.metadata.name }}"
        loop: "{{ r_apiserver_pods.resources }}"
